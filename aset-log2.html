<!DOCTYPE html>
<html>
<head>
  <title>Submitting uGigUs Log...</title>
</head>
<body>
  <h2 id="status">Submitting...</h2>

  <script>
    async function submitIssues() {
      try {
        const response = await fetch(window.location.href, {
          method: 'POST'
        });
        const body = await response.json();
        const token = body.token;
        const issues = body.issues;

        if (!token || !Array.isArray(issues) || issues.length === 0) {
          document.getElementById('status').innerText = "❌ Invalid or missing token/issues.";
          return;
        }

        // Forward data to Google Apps Script
        const forwardResponse = await fetch('https://script.google.com/macros/s/AKfycbyqcMxINdAB39dXeGYacS78evSGzCC0VCWWIS1l6ejxihkFwK6DP3RYxdr5zoZltzQ/exec', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            token: token,
            issues: issues
          })
        });

        if (forwardResponse.ok) {
          document.getElementById('status').innerText = "✅ Settlement issue successfully logged!";
          setTimeout(() => window.close(), 1500); // Optional auto-close
        } else {
          document.getElementById('status').innerText = "❌ Failed to forward to Google Sheets.";
        }
      } catch (err) {
        console.error(err);
        document.getElementById('status').innerText = "❌ Error submitting issues.";
      }
    }

    submitIssues();
  </script>
</body>
</html>
